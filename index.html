<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DartMaster ADMIN | Z치pis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e63946; --bg: #0a0a0a; --card: #141414; --border: #262626; --text: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        nav { background: #000; padding: 15px; display: flex; gap: 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        nav span { cursor: pointer; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: #888; }
        nav span.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .view { display: none; } .view.active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; }
        input { background: #000; color: #fff; border: 1px solid var(--border); padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn { background: var(--primary); color: #fff; border: none; padding: 12px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; }
        .match-line { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #222; cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        .modal-content { background: var(--card); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

<nav>
    <span onclick="v('setup')" id="n-setup" class="active">丘뙖잺 T칳my</span>
    <span onclick="v('play')" id="n-play">游꿢 Hr치t</span>
    <span onclick="v('history')" id="n-history">游닆 Historie</span>
</nav>

<div class="container">
    <div id="setup" class="view active">
        <div class="card">
            <h3>Nov칳 t칳m</h3>
            <input type="text" id="tName" placeholder="N치zev t칳mu">
            <input type="text" id="pNames" placeholder="Hr치캜i (캜치rka)">
            <button class="btn" onclick="addTeam()">Ulo쬴t t칳m</button>
        </div>
        <div id="dbList"></div>
    </div>

    <div id="play" class="view">
        <div id="prezence" class="card">
            <h3>P콏칤prava turnaje</h3>
            <input type="text" id="tourneyTitle" placeholder="N치zev (Nap콏. 2. Kolo ligy)">
            <div id="attList" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            <button class="btn" style="margin-top:20px" onclick="startTourney()">Zah치jit z치pas (3 kola)</button>
        </div>
        <div id="battle" class="view">
            <div class="card">
                <h2 id="bTitle"></h2>
                <div id="battleList"></div>
                <button class="btn" style="margin-top:20px" onclick="finishTourney()">Ukon캜it a odeslat online</button>
            </div>
        </div>
    </div>

    <div id="history" class="view">
        <div id="historyLog"></div>
    </div>
</div>

<div id="scoreModal" class="modal">
    <div class="modal-content">
        <h3 id="curPName">Jm칠no</h3>
        <label>1. Kolo:</label><input type="number" id="s1">
        <label>2. Kolo:</label><input type="number" id="s2">
        <label>3. Kolo:</label><input type="number" id="s3">
        <button class="btn" onclick="saveScore()">ULO콯IT</button>
        <button class="btn" style="background:#444; margin-top:10px" onclick="closeM()">ZAV콎칈T</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://sipky-hospoda-default-rtdb.europe-west1.firebasedatabase.app/" };
    const app = initializeApp(firebaseConfig);
    const fdb = getDatabase(app);

    window.db = []; window.historyData = []; window.activeMatch = null;

    onValue(ref(fdb, 'darts_v15/'), (s) => {
        const d = s.val();
        if(d) { 
            window.db = d.db || []; 
            window.historyData = d.history || []; 
            renderDB(); renderHistory(); renderAtt(); 
        }
    });

    window.v = (id) => {
        document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('nav span').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('n-'+id).classList.add('active');
    };

    window.addTeam = () => {
        const n = document.getElementById('tName').value;
        const p = document.getElementById('pNames').value.split(',').map(x => x.trim()).filter(x => x);
        window.db.push({ name: n, players: p });
        sync();
    };

    function sync() { set(ref(fdb, 'darts_v15/db'), window.db); set(ref(fdb, 'darts_v15/history'), window.historyData); }

    window.renderDB = () => { document.getElementById('dbList').innerHTML = window.db.map((t, i) => `<div class="card"><strong>${t.name}</strong><br><small>${t.players.join(', ')}</small></div>`).join(''); };

    window.renderAtt = () => { document.getElementById('attList').innerHTML = window.db.flatMap(t => t.players.map(p => `<label><input type="checkbox" class="a-ch" data-p="${p}" data-t="${t.name}"> ${p}</label>`)).join(''); };

    window.startTourney = () => {
        const sel = document.querySelectorAll('.a-ch:checked');
        if(sel.length < 1) return;
        window.activeMatch = { 
            id: Date.now(), 
            title: document.getElementById('tourneyTitle').value || "Turnaj", 
            date: new Date().toLocaleDateString(),
            results: Array.from(sel).map(c => ({ name: c.dataset.p, team: c.dataset.t, rounds: [0,0,0], total: 0, done: false }))
        };
        // ODES칈L츼ME INFORMACI 콯E SE HRAJE
        update(ref(fdb, 'darts_v15/status'), { active: true });
        
        document.getElementById('prezence').style.display = 'none';
        document.getElementById('battle').classList.add('active');
        renderBattle();
    };

    function renderBattle() {
        document.getElementById('bTitle').innerText = window.activeMatch.title;
        document.getElementById('battleList').innerHTML = window.activeMatch.results.map((p, i) => `
            <div class="match-line" onclick="openS(${i})">
                <span>${p.name} (${p.team})</span>
                <strong>${p.done ? p.total : 'Zadat'}</strong>
            </div>`).join('');
    }

    window.openS = (i) => {
        window.curIdx = i;
        const p = window.activeMatch.results[i];
        document.getElementById('curPName').innerText = p.name;
        document.getElementById('s1').value = p.rounds[0];
        document.getElementById('s2').value = p.rounds[1];
        document.getElementById('s3').value = p.rounds[2];
        document.getElementById('scoreModal').classList.add('open');
    };

    window.saveScore = () => {
        const r = [parseInt(document.getElementById('s1').value)||0, parseInt(document.getElementById('s2').value)||0, parseInt(document.getElementById('s3').value)||0];
        const p = window.activeMatch.results[window.curIdx];
        p.rounds = r; p.total = r[0] + r[1] + r[2]; p.done = true;
        closeM(); renderBattle();
    };

    window.closeM = () => document.getElementById('scoreModal').classList.remove('open');

    window.finishTourney = () => {
        window.historyData.push(window.activeMatch);
        sync();
        
        // ODES칈L츼ME INFORMACI 콯E JE KONEC
        update(ref(fdb, 'darts_v15/status'), { active: false });
        
        location.reload();
    };

    function renderHistory() { document.getElementById('historyLog').innerHTML = window.historyData.slice().reverse().map(h => `<div class="card"><strong>${h.title}</strong> (${h.date}) <button onclick="delH(${h.id})">Smazat</button></div>`).join(''); }
    
    window.delH = (id) => { if(confirm("Smazat?")) { window.historyData = window.historyData.filter(x => x.id != id); sync(); } };
</script>
</body>
</html>
